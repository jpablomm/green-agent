FROM happysixd/osworld-docker:latest

# Fix the UEFI boot configuration bug
# The original boot.sh incorrectly uses the same file for both ROM and VARS
# and only adds one pflash device. UEFI requires two: CODE (ro) and VARS (rw)

# Fix 1: Use correct VARS file
RUN sed -i 's/VARS="edk2-x86_64-code.fd"/VARS="OVMF_VARS_4M.fd"/' /run/boot.sh

# Fix 2: Add the missing VARS pflash device
# Find the line that adds ROM pflash and add VARS pflash after it
RUN sed -i '/BOOT_OPTS+=" -pflash \$DEST.rom"/a\    BOOT_OPTS+=" -drive if=pflash,format=raw,file=\$DEST.vars"' /run/boot.sh

# Verify the fixes
RUN echo "=== Verifying UEFI fix ===" && \
    grep -A 5 "uefi.*|.*\"\"" /run/boot.sh && \
    echo "=== Fix applied successfully ==="

LABEL description="OSWorld Docker with UEFI boot bug fixed"
LABEL maintainer="green-agent"
LABEL version="1.0-fixed"
